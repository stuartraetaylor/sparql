<?php
// $Id$

class FactbookTestCase extends DrupalTestCase {
  const ENDPOINT = 'http://www4.wiwiss.fu-berlin.de/factbook/sparql';
  const COUNTRY  = 'http://www4.wiwiss.fu-berlin.de/factbook/ns#Country';

  public function get_info() {
    return array(
      'name'  => t('CIA Factbook'),
      'desc'  => t('Executes queries against the CIA Factbook\'s SPARQL endpoint, attempting to parse resultsets in both JSON and XML format.'),
      'group' => t('SPARQL'),
    );
  }

  public function test_json_query() {
    $this->query_classes(array('format' => 'application/sparql-results+json', 'output' => 'json'));
  }

  public function test_xml_query() {
    $this->query_classes(array('format' => 'application/sparql-results+xml', 'output' => 'xml'));
  }

  private function query_classes(array $options = array()) {
    $results = $this->query('SELECT DISTINCT ?class WHERE { [] a ?class } ORDER BY ?class', $options);
    $this->assertTrue(empty($this->errors), t('No errors'));
    $this->assertNotNull($results, t('Has results'));
    $this->assertEqual(count($results), 1, t('Has one result'));
    $this->assertTrue(isset($results[0]['class']), t('Contains ?class column'));
    $this->assertEqual((string)$results[0]['class'], self::COUNTRY, t('Correct answer'));
  }

  private function query($query, array $options = array()) {
    $this->errors = array();
    return sparql_query($query, array_merge(array('endpoint' => self::ENDPOINT), $options), $this->errors);
  }
}
